import { build } from "esbuild";
import { rmSync, existsSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const outdir = "dist";
const srcFile = path.resolve("src/server.<%= language === 'typescript' ? 'ts' : 'js' %>");

if (!existsSync("src")) {
  console.error("Source folder not found. Make sure 'src/' exists before building.");
  process.exit(1);
}

try {
  // Clean old build
  rmSync(outdir, { recursive: true, force: true });

  await build({
    entryPoints: [srcFile],
    outdir,
    bundle: true,
    platform: "node",
    target: ["node20"],
    format: "esm",
    sourcemap: true,
    minify: false,
    logLevel: "info",
    tsconfig: path.resolve("tsconfig.json"),
  });

  console.log("Build completed successfully.");
} catch (error) {
  console.error("Build failed:", error);
  process.exit(1);
}
