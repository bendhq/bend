name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    name: ${{ matrix.os }} â€¢ ${{ matrix.pm }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        pm: [npm, pnpm, yarn, bun]
        exclude:
          - os: windows-latest
            pm: bun

    env:
      NODE_VERSION: '22.12.0'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - if: matrix.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - if: matrix.pm == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.30'

      - run: |
          node -v
          npm -v
          if [ "${{ matrix.pm }}" = "pnpm" ]; then pnpm -v; fi
          if [ "${{ matrix.pm }}" = "yarn" ]; then yarn -v || true; fi
          if [ "${{ matrix.pm }}" = "bun" ]; then bun -v; fi
        shell: bash

      - run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi
        shell: bash

      - run: npm run lint
      - run: npm run build

      - run: |
          mkdir -p scripts
          cat > scripts/e2e-driver.js <<'EOF'
          import { spawn } from "node:child_process";
          import { mkdirSync, rmSync } from "node:fs";
          import { join } from "node:path";

          const delays = { short: 120, mid: 220 };
          function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
          function keyOf(val) {
            const m = { typescript: "t", javascript: "j", express: "e", fastify: "f", mongoose: "m", prisma: "p", none: "n", npm: "n", pnpm: "p", yarn: "y", bun: "b" };
            return m[val];
          }

          async function runOne({ lang, fw, orm, pm, name }) {
            const projectDir = join(process.cwd(), name);
            try { rmSync(projectDir, { recursive: true, force: true }); mkdirSync(projectDir, { recursive: true }); } catch {}
            const child = spawn(process.platform === "win32" ? "node.exe" : "node", ["dist/index.js"], {
              stdio: ["pipe", "inherit", "inherit"],
              env: { ...process.env },
              cwd: process.cwd(),
            });
            child.stdin.write(keyOf(lang) + "\r");
            await sleep(delays.mid);
            child.stdin.write(keyOf(fw) + "\r");
            await sleep(delays.mid);
            child.stdin.write(keyOf(orm) + "\r");
            await sleep(delays.mid);
            child.stdin.write(name + "\r");
            await sleep(delays.mid);
            child.stdin.write(keyOf(pm) + "\r");
            await sleep(delays.mid);
            return new Promise((resolve, reject) => {
              child.on("error", reject);
              child.on("close", (code) => (code === 0 ? resolve() : reject(new Error("generator exited " + code))));
            });
          }

          async function smokeRun({ pm, dir }) {
            const cmds = {
              npm: (a, c) => spawn("npm", a, { cwd: c, stdio: "inherit", shell: false }),
              pnpm: (a, c) => spawn("pnpm", a, { cwd: c, stdio: "inherit", shell: false }),
              yarn: (a, c) => spawn("yarn", a, { cwd: c, stdio: "inherit", shell: false }),
              bun: (a, c) => spawn(process.platform === "win32" ? "bun.exe" : "bun", a, { cwd: c, stdio: "inherit", shell: false }),
            };
            function runOnce(a) {
              return new Promise((resolve) => {
                const c = cmds[pm](a, dir);
                c.on("close", () => resolve());
                c.on("error", () => resolve());
              });
            }
            await runOnce(["run", "build"]);
          }

          async function main() {
            const pm = process.env.PM;
            const combos = [
              { lang: "typescript", fw: "express", orm: "mongoose" },
              { lang: "typescript", fw: "express", orm: "prisma" },
              { lang: "typescript", fw: "express", orm: "none" },
              { lang: "typescript", fw: "fastify", orm: "mongoose" },
              { lang: "typescript", fw: "fastify", orm: "prisma" },
              { lang: "typescript", fw: "fastify", orm: "none" },
              { lang: "javascript", fw: "express", orm: "mongoose" },
              { lang: "javascript", fw: "express", orm: "prisma" },
              { lang: "javascript", fw: "express", orm: "none" },
              { lang: "javascript", fw: "fastify", orm: "mongoose" },
              { lang: "javascript", fw: "fastify", orm: "prisma" },
              { lang: "javascript", fw: "fastify", orm: "none" },
            ];
            for (const c of combos) {
              const name = `e2e-${c.lang}-${c.fw}-${c.orm}-${pm}`.replace(/[^a-z0-9-]/gi, "-").toLowerCase();
              console.log(`\n=== Generating ${name} with ${pm} ===\n`);
              await runOne({ ...c, pm, name });
              await smokeRun({ pm, dir: join(process.cwd(), name) });
            }
          }
          main().catch((e) => { console.error(e); process.exit(1); });
          EOF
        shell: bash

      - env:
          PM: ${{ matrix.pm }}
        run: node scripts/e2e-driver.js
